(function(){'use strict';function a(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}function b(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}function c(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}function d(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}function e(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}function f(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}function g(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}function h(){PIXI.settings.SCALE_MODE=PIXI.SCALE_MODES.NEAREST,PIXI.settings.MIPMAP_TEXTURES=PIXI.MIPMAP_MODES.OFF}function i(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}var j=Math.max,k=Math.min,l=Math.abs,m=Math.floor,n={basename({path:a,extension:b}){return a.substring(1+a.lastIndexOf("/")).replace(/(\..+?)$/,b?"$1":"")},mget({map:a,key:b,create:c}){return!a.has(b)&&a.set(b,c(b)),a.get(b)},dist(c,a){return Math.sqrt((a.x-c.x)**2+(a.y-c.y)**2)},to:{coord:{px(a){return a*z.Chunk.tile.size},tile(a){return m(a/z.Chunk.tile.size)}}},sync({a:c,b:a}){for(let b in a)c[b]=a[b]},shuffle(a){a=[...a];for(let b=a.length-1,c=0;0<b;b--)[a[b],a[c=m(Math.random()*(b+1))]]=[a[c],a[b]];return a}},o={animated:{2374:{frames:[2374,2375,2376,2377,2378,2379,2380,2381].map(a=>`${a}`),speed:.075},429:{frames:[429,430].map(a=>`${a}`),speed:.05}}};class p{constructor(){a(this,"origin",{x:1/0,y:1/0}),a(this,"boundary",{x:-Infinity,y:-Infinity})}get x(){return this.origin.x}get y(){return this.origin.y}get width(){return l(this.boundary.x-this.origin.x)}get height(){return l(this.boundary.y-this.origin.y)}}class q extends p{constructor({world:a,key:c}){super(...arguments),b(this,"layers",new Map),this.key=c,this.world=a,this.sprite=new PIXI.Container,this.sprite.name=this.key}async load({layer:{name:a},chunk:{x:b,y:c,width:d,height:e,data:f}}){this.layers.set(a,{x:b,y:c,width:d,height:e,data:f}),this.origin={x:k(b,this.origin.x),y:k(c,this.origin.y)},this.boundary={x:j(b,this.boundary.x),y:j(c,this.boundary.y)};const{origin:g,boundary:h}=this.world;n.sync({a:g,b:{x:k(this.origin.x,g.x),y:k(this.origin.y,g.y)}}),n.sync({a:h,b:{x:j(this.boundary.x,h.x),y:j(this.boundary.y,h.y)}})}async render({force:a,animated:b,cache:c,fade:d}){const e={rendered:!1};for(let[f,{x:g,y:h,width:i,height:j,data:k}]of this.layers.entries()){if(z.layers.ignored.has(f))continue;const d=this.sprite.getChildByName(f)||this.sprite.addChild(new PIXI.Container);if(d.name=f,d.position.set(n.to.coord.px(g),n.to.coord.px(h)),d.children.length&&!a){e.rendered=!0;continue}e.rendered=!0,e.local={},d.cacheAsBitmap=!1,d.removeChildren();for(let[a,c]of k.entries()){let f=null;0>--c||(c in o.animated?(f=d.addChild(new PIXI.AnimatedSprite(o.animated[c].frames.map(PIXI.Texture.from))),f.animationSpeed=o.animated[c].speed,b&&(b.add(f),e.local.animated=!0)):f=d.addChild(new PIXI.Sprite.from(`${c}`)),f.position.set(n.to.coord.px(a%i),n.to.coord.px(~~(a/i))),f.width=f.height=z.Chunk.tile.size)}c&&(d.cacheAsBitmap=!0),e.local.animated||(d.cacheAsBitmap=!0)}e.rendered&&(d&&this.world.app.tween.fade({target:this.sprite,from:0,to:1,duration:15}),this.world.layers.global.world.addChild(this.sprite))}static key({x:a,y:b}){return`${a};${b}`}}b(q,"tile",{size:16});class r{constructor({world:a}){this.world=a,this.sprite=new PIXI.Sprite,this.render({delay:0}),this.world.layers.global.sea.addChild(this.sprite)}async render({delay:a=250}={}){clearTimeout(this._render),this._render=setTimeout(async()=>{this.sprite.removeChildren(),this.sprite.anchor.set(.5);const a=n.to.coord.tile(this.world.app.renderer.view.width),b=n.to.coord.tile(this.world.app.renderer.view.height),c=o.animated[`${z.Sea.texture}`];for(let d=-a;d<=a;d++)for(let a=-b;a<=b;a++){const b=this.sprite.addChild(new PIXI.AnimatedSprite(c.frames.map(PIXI.Texture.from)));b.animationSpeed=c.speed,b.position.set(n.to.coord.px(d),n.to.coord.px(a)),b.width=b.height=z.Chunk.tile.size,b.play()}},a)}refresh({x:a,y:b}){const{origin:c}=this.world;this.sprite.alpha=0,this.sprite.position.set(n.to.coord.px(c.x+a),n.to.coord.px(c.y+b)),this.world.app.tween.fade({target:this.sprite,change:"alpha",from:0,to:1,duration:15})}}c(r,"texture",2374);class s extends p{constructor({world:a,key:b}){super(...arguments),this.key=b,this.world=a,this.sprite=new PIXI.Container,this.sprite.visible=!1,this.world.layers.global.areas.addChild(this.sprite)}async load({object:a}){const{polygon:b,x:c,y:d,properties:e=[]}=a;this.properties={},e.map(({name:a,value:b})=>this.properties[a]=b);const f=b.map(a=>n.to.coord.tile(c+a.x)),g=b.map(a=>n.to.coord.tile(d+a.y));this.origin={x:k(...f),y:k(...g)},this.boundary={x:j(...f),y:j(...g)};const h=n.to.coord.tile(c)-this.origin.x,i=n.to.coord.tile(d)-this.origin.y;this.area={tiled:b.map(a=>[n.to.coord.tile(c+a.x),n.to.coord.tile(d+a.y)]),px:b.map(a=>[n.to.coord.px(h)+a.x,n.to.coord.px(i)+a.y]),size:0};let m=0;for(let b=0,c=this.area.tiled;b<c.length;b++)m+=.5*(c[b][0]*c[b==c.length-1?0:b+1][1])-.5*(c[b==c.length-1?0:b+1][0]*c[b][1]);this.area.size=l(m),this.sprite.position.set(n.to.coord.px(this.origin.x),n.to.coord.px(this.origin.y))}inside({x:a,y:b}){const c=this.area.tiled;let d=!1;for(let e=0,f=c.length-1;e<c.length;f=e++){const g=c[e][0],h=c[e][1],i=c[f][0],j=c[f][1];h>b!=j>b&&a<(i-g)*(b-h)/(j-h)+g&&(d=!d)}return d}async render(){if(x.debug){this.sprite.removeChildren(),this.graphics=this.sprite.addChild(new PIXI.Graphics),this.graphics.beginFill(16711680,.5).drawPolygon(this.area.px.flat()).endFill(),this.sprite.visible=!0;const a=this.area.px;for(let b=0;b<a.length;b++){const c=this.graphics.addChild(new PIXI.Text(b,{fontSize:12}));c.position.set(a[b][0],a[b][1]),c.anchor.set(.5)}}}async update({center:a,radius:b}){const{x:c,y:d}={x:this.x-this.world.origin.x,y:this.y-this.world.origin.y};return n.dist(a,{x:c,y:d})>b?this.reset():void(!this.created&&this.create(),this.render())}create(){}reset(){this.created&&(this.sprite.visible=!1,this.sprite.removeChildren(),this.created=!1)}static from({world:a,key:b,object:c}){const{type:d}=c;return"wild"===d?new s.Wild(...arguments):new s({world:a,key:b})}}class t{constructor({x:a=0,y:b=0,width:c=400,height:d=400,parent:e=null,max:f={items:20,depth:20}}={}){this.resize({x:a,y:b,width:c,height:d,rebuild:!1}),this.parent=e,this.nodes=[null,null,null,null],this.items={node:new Set,all:new Set},this.parent?(this.max=this.parent.max,this.depth=this.parent.depth+1):(this.max=f,this.depth=0)}get leaf(){return null===this.nodes[0]}get root(){return 0===this.depth}get size(){return this.items.all.size}add(a){if(4>[a.x,a.y,a.width,a.height].filter(Number.isFinite).length)throw new Error(`Cannot add value to quadtree, missing coordinates or dimensions`);this.items.all.add(a),this.leaf?(this.items.node.add(a),this.items.node.size>this.max.items&&this.depth<this.max.depth&&this.split()):this.index(a).forEach(b=>this.nodes[b].add(a))}delete(a){this.items.all.delete(a),this.leaf?this.items.node.delete(a):this.index(a).forEach(b=>this.nodes[b].delete(a))}get(a,{list:b=new Set,exclude:c=null}={}){return this.leaf?(this.items.node.forEach(a=>b.add(a)),c&&c.forEach(a=>b.delete(a))):this.index(a).forEach(c=>this.nodes[c].get(a,{list:b,self})),b}index({x:a,y:b,width:c,height:d}){const e=b+d<this.y+this.height/2?"N":b>this.y+this.height/2?"S":"B",f=a+c<this.x+this.width/2?"W":a>this.x+this.width/2?"E":"B";return t.INDEXES[e+f]}clear({soft:a=!1}={}){a||this.items.all.clear(),this.items.node.clear(),this.leaf||this.nodes.forEach(a=>a.clear()),this.root?this.nodes=[null,null,null,null]:this.items=this.parent=this.nodes=null}rebuild(){return this.root&&(this.clear({soft:!0}),this.items.all.forEach(a=>this.add(a))),this}resize({x:a,y:b,width:c,height:d,rebuild:e}){return this.x=a,this.y=b,this.width=c,this.height=d,e&&this.rebuild(),this}split(){if(this.leaf){const{x:a,y:b}=this,c=this.width/2,d=this.height/2;for(let[e,f]of Object.entries({[t.INDEX.NW]:{width:c,height:d,x:a,y:b},[t.INDEX.NE]:{width:c,height:d,x:a+c,y:b},[t.INDEX.SE]:{width:c,height:d,x:a+c,y:b+d},[t.INDEX.SW]:{width:c,height:d,x:a,y:b+d}}))this.nodes[e]=new t({parent:this,...f});this.items.node.forEach(a=>this.add(a)),this.items.node.clear()}}}d(t,"INDEX",{NW:0,NE:1,SE:2,SW:3}),d(t,"INDEXES",{NW:[0],NE:[1],SE:[2],SW:[3],BE:[1,2],BW:[0,3],NB:[0,1],SB:[2,3],BB:[0,1,2,3]});class u extends p{constructor({world:a}){super(...arguments),e(this,"_x",0),e(this,"_y",0),this.world=a}set x(a){this._x=a,this.sprite&&(this.sprite.position.x=n.to.coord.px(this.x)+z.Chunk.tile.size/2)}get x(){return this._x}set y(a){this._y=a,this.sprite&&(this.sprite.position.y=n.to.coord.px(this.y)+(this.sprite.height-z.Chunk.tile.size))}get y(){return this._y}update(){}destroy(){this.sprite&&(this.sprite.visible=!1,this.sprite.destroy(),this.sprite=null)}}class v extends u{constructor({species:a,x:b,y:c,area:d}){super(...arguments),this.species=a,this.area=d,this.sprite=new PIXI.AnimatedSprite(v.textures({species:a})),this.world.layers.global.characters.addChild(this.sprite),this.sprite.animationSpeed=.125,this.sprite.anchor.set(.5,1),this.sprite.play(),this.x=b,this.y=c,this.world.app.tween.fade({target:this.sprite,from:0,to:1,duration:15}),this.lifetime=16+m(16*Math.random())}static textures({species:a}){return x.loader.renderer.resources["/maps/creatures/creatures.json"].data.animations[a].map(PIXI.Texture.from)}wander(){const{x:a,y:b}=this,{dx:c,dy:d}=[{dx:0,dy:0},{dx:-1,dy:0},{dx:1,dy:0},{dx:0,dy:-1},{dx:0,dy:1}][m(Math.random()/.25)];(c||d)&&this.area.inside({x:a+c,y:b+d})&&(c&&(this.world.app.tween.property({target:this,change:"x",from:this.x,to:this.x+c,duration:8}),this.sprite.scale.x=-Math.sign(c)),d&&this.world.app.tween.property({target:this,change:"y",from:this.y,to:this.y+d,duration:8}))}update(){0<this.lifetime--?this.wander():(this.area.creatures.delete(this),this.world.app.tween.fade({target:this.sprite,from:1,to:0,duration:15,callback:()=>this.destroy()}))}}class w extends s{constructor(){super(...arguments),f(this,"creatures",new Set),f(this,"species",{})}async load(){await super.load(...arguments);const a=Object.keys(this.properties).filter(a=>w.species.property.test(a));let b=0;for(let c of a){const a=this.properties[c];this.species[`${b}-${b+a}`]=c.replace(w.species.property,""),b=a}this.spawns={max:{creatures:this.properties.max_creatures||this.area.size/8},probability:.4}}async update(){var a=Number.isFinite;if(await super.update(...arguments),this.creatures.size<this.spawns.max.creatures&&Math.random()<this.spawns.probability){let b=null;const c=Math.random();for(let d in this.species){const[e,a]=d.split("-").map(Number);if(e<c&&c<a){b=this.species[d];break}}let d=NaN,e=NaN,f=n.shuffle(this.area.tiled);for(let a of f)if(this.inside({x:a[0],y:a[1]})){[d,e]=a;break}if(b&&a(d)&&a(e)){const a=this.world.add.creature({species:b,x:d,y:e,area:this});this.creatures.add(a)}}this.creatures.forEach(a=>a.update())}reset(){super.reset(),this.creatures.forEach(a=>a.destroy()),this.creatures.clear()}}f(w,"species",{property:/^pk_/});class z extends p{constructor({app:a,name:b}){super(...arguments),g(this,"chunks",new Map),g(this,"areas",new Map),g(this,"qt",{chunks:new t({max:{items:128,depth:64}}),areas:new t({max:{items:128,depth:64}})}),g(this,"cache",{ticked:-Infinity,rendered:new Promise(a=>this._rendered=a)}),g(this,"load",{world:async()=>{x.loader.renderer.add(`/maps/creatures/creatures.json`);const{layers:a,tilesets:b}=(await axios.get(`/maps/${this.name}/map.json`)).data;for(let a of b)x.loader.renderer.add(`/maps/${this.name}/${n.basename({path:a.source,extension:!1})}.textures.json`);for(let b of a)switch(b.type){case"tilelayer":{for(let a of b.chunks)await n.mget({map:this.chunks,key:z.Chunk.key(a),create:a=>new z.Chunk({world:this,key:a})}).load({layer:b,chunk:a});break}case"objectgroup":{for(let a of b.objects)await n.mget({map:this.areas,key:a.name,create:b=>z.Area.from({world:this,key:b,object:a})}).load({object:a});break}}this.app.viewport.left=n.to.coord.px(this.origin.x),this.app.viewport.top=n.to.coord.px(this.origin.y),this.app.viewport.worldWidth=n.to.coord.px(this.width),this.app.viewport.worldHeight=n.to.coord.px(this.height),this.app.data.maps=(await axios.get(`/maps/${this.name}/locations.json`)).data,this.qt.chunks.resize({...this.origin,width:this.width,height:this.height}).clear(),this.chunks.forEach(a=>this.qt.chunks.add(a)),this.qt.areas.resize({...this.origin,width:this.width,height:this.height}).clear(),this.areas.forEach(a=>this.qt.areas.add(a)),this.sprite.position.set(n.to.coord.px(-this.origin.x),n.to.coord.px(-this.origin.y))},sea:async()=>{this.sea=new z.Sea({world:this})}}),g(this,"add",{creature:({species:a,x:b,y:c,area:d})=>new v({world:this,x:b,y:c,area:d,species:a})}),this.name=this.key=b,this.app=a,this.sprite=new PIXI.Container,this.sprite.name=this.name,this.app.viewport.addChild(this.sprite),this.layers={global:{sea:this.sprite.addChild(new PIXI.Container),world:this.sprite.addChild(new PIXI.Container),characters:this.sprite.addChild(new PIXI.Container),areas:this.sprite.addChild(new PIXI.Container)}},this.layers.global.characters.visible=!1,s.Wild=w}async render({center:a=this.app.data.user.position,delay:b=100,radius:c="auto",offset:d=this.origin,force:e=!1}={}){clearTimeout(this._render),this._render=setTimeout(async()=>{"auto"===c&&(c=Math.ceil(1.5*j(n.to.coord.tile(this.app.renderer.view.height),n.to.coord.tile(this.app.renderer.view.width)))),d&&(a={x:a.x+d.x,y:a.y+d.y});const f=this.qt.chunks.get({x:a.x-c,y:a.y-c,width:2*c,height:2*c}),g=new Set,h=[],i=[...this.layers.global.world.children];this.layers.global.world.removeChildren();for(let a of f)h.push(a.render({force:e,animated:g,fade:b&&!i.includes(a.sprite)}));await Promise.all(h),g.forEach(a=>(a.play(),a.parent.cacheAsBitmap=!1)),this.sea.refresh(this.app.data.user.position),this.layers.global.characters.visible=!0,this.app.params.get.update({x:this.app.data.user.position.x,y:this.app.data.user.position.y}),!0!==this.cache.rendered&&(this._rendered(),this.cache.rendered=!0)},b)}camera({x:a,y:b,offset:c=this.origin}){this.app.viewport.moveCenter({x:n.to.coord.px(a-c.x),y:n.to.coord.px(b-c.y)}),this.app.methods.update(),this.render()}start(){this.app.renderer.ticker.add(()=>this.ticker())}ticker(){if(1e3<x.time-this.cache.ticked){const a=this.app.data.user.position,b=j(n.to.coord.tile(this.app.renderer.view.height),n.to.coord.tile(this.app.renderer.view.width)),c=this.qt.areas.get({x:a.x-b,y:a.y-b,width:2*b,height:2*b});c.forEach(c=>c.update({center:a,radius:b})),this.cache.ticked=x.time}}}g(z,"layers",{ignored:new Set(["00-boundaries"])}),g(z,"Chunk",q),g(z,"Sea",r),g(z,"Area",s);class x{constructor({world:a}){i(this,"ready",new Promise(()=>null)),i(this,"data",{user:{position:{x:0,y:0}},maps:[],show:{map:!1},lang:{},loading:{state:"Loading...",done:!1}}),i(this,"methods",{camera:({x:a,y:b,offset:c})=>this.world.camera({x:a,y:b,offset:c}),update:()=>this.data.user.position={x:n.to.coord.tile(this.view.center.x),y:n.to.coord.tile(this.view.center.y)},render:()=>this.world.render(),redirect:a=>window.location.replace(a)}),i(this,"renderer",new PIXI.Application({width:document.body.clientWidth,height:document.body.clientHeight,transparent:!0,resizeTo:window,antialias:!0})),i(this,"viewport",new Viewport.Viewport({screenWidth:window.innerWidth,screenHeight:window.innerHeight,interaction:this.renderer.renderer.plugins.interaction})),i(this,"view",this.renderer.stage.addChild(this.viewport)),i(this,"controller",new Vue({el:"#app",data:this.data,methods:this.methods,mounted:()=>document.querySelector("#app .view").appendChild(this.renderer.view)})),i(this,"params",{get:{update:a=>{for(let[b,c]of Object.entries(a))this.params.get.map.set(b,c);window.history.pushState("","",`/?${this.params.get.map.toString()}`)},map:new URLSearchParams(window.location.search)}}),i(this,"tween",{quadInOut:a=>a*a,fade:({target:a,from:b,to:c,duration:d,callback:e})=>{const f=a.cacheAsBitmap;a.cacheAsBitmap=!1,this.tween.property({target:a,change:"alpha",from:b,to:c,duration:d,callback:()=>{a.cacheAsBitmap=f,e&&e()}})},property:({target:a,change:b,from:c,to:d,duration:e,callback:f})=>{let g=0,h=d>c?k:j;const i=j=>{1<=(g+=j)/e?(a[b]=d,this.renderer.ticker.remove(i),f&&f()):a[b]=h(d,c+(d-c)*this.tween.quadInOut(g/e))};this.renderer.ticker.add(i)}}),h(),this.world=new z({app:this,name:a}),this.view.on("moved",()=>this.methods.update()),this.view.on("moved-end",()=>this.methods.render()),this.view.on("zoomed-end",()=>this.methods.render()),this.view.drag().pinch().wheel().decelerate().clamp({direction:"all"}).clampZoom({minScale:.5,maxScale:1}),this.view.scale.set(1),this.ready=new Promise(async()=>{const a=axios.get(`/lang/${this.params.get.map.get("lang")||"en"}.json`);this.data.loading.state="Loading world...",await this.world.load.world(),x.loader.renderer.load(async()=>{this.data.loading.state="Loading sea...",await this.world.load.sea(),this.data.loading.state="Loading camera...",this.methods.camera(this.params.get.map.has("x")&&this.params.get.map.has("y")?{x:+this.params.get.map.get("x")||0,y:+this.params.get.map.get("y")||0,offset:{x:0,y:0}}:{x:329,y:-924}),this.methods.update(),this.data.loading.state="Loading life...",this.world.start(),this.data.loading.state="Loading lang...",this.data.lang=(await a).data,this.data.loading.state="Waiting for first rendering...",await this.world.render({delay:0,fade:!1}),await this.world.cache.rendered,this.data.loading.done=!0})})}static get time(){return PIXI.Ticker.shared.lastTime}}i(x,"loader",{renderer:PIXI.Loader.shared}),i(x,"debug",!1),async function(){const a=new x({world:"overworld"});await a.ready}()})();
